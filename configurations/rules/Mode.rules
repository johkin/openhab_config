import org.joda.time.*
import org.openhab.model.script.actions.Timer
import org.openhab.core.library.types.DecimalType
import org.openhab.core.library.types.DateTimeType
import org.openhab.core.library.items.SwitchItem

var Timer offTimer


var Integer minutesOn = 120

rule "Initiering"
when
	System started
then
	logDebug("mode", "Intiering, skapar timer.")
	offTimer = createTimer(now.plusMinutes(minutesOn)) [|
		logDebug("mode", "Ingen rörelse inom angiven tid {}", minutesOn)
		// All_Lights.allMembers.forEach[light| sendCommand(light, OFF)]
	]
end

rule "Avsluta timer vid rörelse"
when
	Item gMotionSensorIndoor received update
then
	logDebug("mode", "Rörelse ändrad")
	if(gMotionSensorIndoor.allMembers.filter([sensor| 
		sensor.state == OPEN]).empty) {
			logDebug("mode", "Alla sensorer är Closed, tar bort befintlig timer")
			if (offTimer != null) {
				offTimer.cancel
				offTimer = null
			}
			logDebug("mode", "Skapar ny timer")
			offTimer = createTimer(now.plusMinutes(minutesOn)) [|
				logDebug("mode", "Ingen rörelse inom angiven tid {}", minutesOn)
				// All_Lights.allMembers.forEach[light| sendCommand(light, OFF)]
			]
		} else {
			logDebug("mode", "Minst en sensor är Open, tar bort timer.")
			if (offTimer != null) {
				offTimer.cancel
				offTimer = null
			}
		}
end